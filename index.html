<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>Med Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
  :root {
    --bg: #f8f9fa;
    --surface: #ffffff;
    --accent: #2dbb5d; 
    --text: #000000;
    --text-muted: #555555;
    --danger: #d93025;
    --border: #dee2e6;
    --tag-bg: #e7f3ff;
    --tag-text: #007bff;
    --dose-bg: #ffe7e7;
    --dose-text: #d93025;
    --roa-bg: #fff9db;
    --roa-text: #856404;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Mono', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 20px 20px 160px;
  }

  .header { text-align: center; margin-bottom: 30px; }
  .header h1 { font-family: 'Playfair Display', serif; font-size: 2rem; }
  .header p { color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; }

  .footer-credit { 
    text-align: center; 
    font-size: 0.65rem; 
    color: var(--text-muted); 
    margin-top: 20px; 
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .container { max-width: 520px; margin: 0 auto; display: flex; flex-direction: column; gap: 16px; }

  .timing-group { border-radius: 16px; margin-bottom: 24px; overflow: hidden; }
  .group-header { 
    background: #eee; 
    padding: 12px 20px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    cursor: pointer; 
    font-weight: 700;
    font-size: 0.9rem;
    border-radius: 12px;
    margin-bottom: 8px;
  }
  .group-content { display: flex; flex-direction: column; gap: 16px; }
  .group-content.collapsed { display: none; }

  .timer-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }
  .timer-card.running { border-color: var(--accent); border-width: 2px; }

  .name-row { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; margin-bottom: 10px; }
  .med-title { font-family: 'Playfair Display', serif; font-size: 1.2rem; font-weight: 700; flex: 1; min-width: 150px; }

  .time-display { 
    font-family: 'DM Mono', monospace; 
    font-size: 2.8rem; 
    text-align: center; 
    margin: 10px 0 20px; 
    color: var(--text);
  }
  .running .time-display { color: var(--accent); }

  .controls { display: flex; justify-content: center; gap: 10px; }
  .btn { 
    font-family: 'DM Mono', monospace; 
    font-size: 0.7rem; 
    text-transform: uppercase; 
    border: 1.5px solid; 
    border-radius: 8px; 
    padding: 10px 24px; 
    cursor: pointer; 
    background: white;
    color: var(--text);
  }
  .btn-start { border-color: var(--accent); color: var(--accent); }
  .btn-stop { border-color: var(--danger); color: var(--danger); }
  .btn-danger-fill { background: var(--danger); color: white; border: none; }

  .badge { 
    font-size: 0.75rem; 
    padding: 6px 12px; 
    border-radius: 12px; 
    background: var(--tag-bg); 
    font-weight: 500; 
    color: var(--tag-text); 
    text-transform: uppercase;
    margin: 4px 2px;
    display: inline-block;
  }

  .badge-red { background: var(--dose-bg); color: var(--dose-text); }
  .badge-yellow { background: var(--roa-bg); color: var(--roa-text); }

  .add-btn-container { margin-top: 20px; margin-bottom: 40px; }

  .summary-bar {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: black;
    color: white;
    padding: 18px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    z-index: 1001;
    text-align: center;
    box-shadow: 0 -4px 15px rgba(0,0,0,0.1);
  }

  .drawer {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: white;
    border-top: 1px solid var(--border);
    border-radius: 20px 20px 0 0;
    transform: translateY(100%);
    transition: transform(0.3s) cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1002;
    padding: 20px;
    max-height: 80vh;
    overflow-y: auto;
  }
  .drawer.open { transform: translateY(0); }
  .drawer-handle { width: 40px; height: 5px; background: #ddd; border-radius: 10px; margin: -10px auto 20px; }
  
  .total-row { padding: 16px 0; border-bottom: 1px solid #f0f0f0; color: black; }

  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 1100; justify-content: center; align-items: center; }
  .modal-overlay.show { display: flex; }
  .modal { background: white; border-radius: 20px; padding: 25px; width: 90%; max-width: 400px; color: black; overflow-y: auto; max-height: 90vh; }
  
  .modal-input, .modal-select { 
    width: 100%; 
    height: 48px; /* Standardized height */
    padding: 0 12px; 
    margin-bottom: 12px; 
    border: 1px solid var(--border); 
    border-radius: 8px; 
    font-family: 'DM Mono', monospace; 
    font-size: 0.9rem; 
    background: white;
    display: block;
    -webkit-appearance: none; /* Uniform look on iOS */
  }

  /* Specific reset for time input to ensure same proportions */
  input[type="time"].modal-input {
    line-height: 48px;
  }

  .inline-group { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 12px; }
  .inline-group > div { flex: 1; }
  .stepper-row { display: flex; align-items: center; margin-bottom: 15px; }
  .stepper-btn { background: #eee; border: 1px solid var(--border); width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem; }
  .stepper-num { flex: 1; text-align: center; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); height: 40px; line-height: 40px; }

  .clock-icon-svg {
    width: 16px;
    height: 16px;
    margin-right: 8px;
    vertical-align: middle;
  }
</style>
</head>
<body>

<div class="header">
  <h1>Medication Tracker</h1>
  <p>Follow & time your medications.</p>
  <div class="footer-credit">Created by Christopher MacCarthy</div>
</div>

<div class="container" id="container">
  <div id="timersRoot"></div>
  <div class="add-btn-container">
    <button class="btn" style="width:100%; padding:15px; color:black; border-color: black;" onclick="openModal()">+ Add New Med</button>
  </div>
</div>

<div class="summary-bar" onclick="toggleDrawer()">
  View Cumulative Totals
</div>

<div class="drawer" id="drawer">
  <div class="drawer-handle" onclick="toggleDrawer()"></div>
  <h2 style="font-family:'Playfair Display'; margin-bottom:5px; color: black;">Dose Tracking</h2>
  <div id="totalsList"></div>
  <div style="margin-top: 30px; display: flex; flex-direction: column; gap: 10px;">
    <button class="btn btn-danger-fill" style="width:100%; padding: 12px;" onclick="confirmClearTotals()">Reset All Totals</button>
    <button class="btn" style="width:100%; padding: 12px; border-color: #777; color: black;" onclick="toggleDrawer()">Close</button>
  </div>
</div>

<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <h2 style="font-family:'Playfair Display'; margin-bottom: 15px;">Add Medication</h2>
    
    <label style="font-size: 0.7rem; text-transform: uppercase; color: #777;">Medication Name</label>
    <input class="modal-input" id="modalInput" type="text" placeholder="e.g. Escitalopram">
    
    <label style="font-size: 0.7rem; text-transform: uppercase; color: #777;">Timing Group</label>
    <input class="modal-input" id="modalInputTime" type="time">

    <div class="inline-group">
      <div>
        <label style="font-size: 0.7rem; text-transform: uppercase; color: #777;">Amount</label>
        <input class="modal-input" id="modalInputDosage" type="number" placeholder="Amt" style="margin-bottom:0;">
      </div>
      <div>
        <label style="font-size: 0.7rem; text-transform: uppercase; color: #777;">Unit</label>
        <select class="modal-select" id="modalSelectUnit" onchange="checkOtherUnit(this.value)" style="margin-bottom:0;">
          <option value="mg">mg</option>
          <option value="μg">μg</option>
          <option value="g">g</option>
          <option value="Other">Other</option>
        </select>
      </div>
    </div>
    <input class="modal-input" id="modalInputOtherUnit" type="text" placeholder="Specify unit..." style="display:none;">

    <label style="font-size: 0.7rem; text-transform: uppercase; color: #777;">Release Type</label>
    <select class="modal-select" id="modalSelectRelease">
        <option value="">None</option>
        <option value="Instant-Release">Instant-Release</option>
        <option value="Extended-Release">Extended-Release</option>
    </select>

    <label style="font-size: 0.7rem; text-transform: uppercase; color: #777;">Medium</label>
    <select class="modal-select" id="modalSelectMedium" onchange="checkOtherMedium(this.value)">
        <option value="Tablet">Tablet</option>
        <option value="Capsule">Capsule</option>
        <option value="Caplet">Caplet</option>
        <option value="Lozenge">Lozenge</option>
        <option value="Nasal Spray">Nasal Spray</option>
        <option value="Other">Other</option>
    </select>
    <input class="modal-input" id="modalInputOtherMedium" type="text" placeholder="Specify other medium..." style="display:none;">

    <label style="font-size: 0.7rem; text-transform: uppercase; color: #777;">Route</label>
    <select class="modal-select" id="modalSelectRoa">
        <option value="Oral">Oral</option>
        <option value="Sublingual">Sublingual</option>
        <option value="Topical">Topical</option>
        <option value="Inhalation">Inhalation</option>
        <option value="Nasal">Nasal</option>
        <option value="Injection">Injection</option>
    </select>

    <label style="font-size: 0.7rem; text-transform: uppercase; color: #777;">Initial Dose #</label>
    <div class="stepper-row">
      <button class="stepper-btn" style="border-radius: 8px 0 0 8px;" onclick="changeDoseNum(-1)">−</button>
      <div class="stepper-num" id="stepperVal">1</div>
      <button class="stepper-btn" style="border-radius: 0 8px 8px 0;" onclick="changeDoseNum(1)">+</button>
    </div>

    <div style="display:flex; gap:10px; margin-top:10px">
      <button class="btn" style="flex:1; border-color: #777; color: black;" onclick="closeModal()">Cancel</button>
      <button class="btn btn-start" style="flex:1" onclick="saveNewTimer()">Add</button>
    </div>
  </div>
</div>

<script>
  let timers = [];
  let dailyLog = {}; 
  let modalDoseNum = 1;
  let collapsedGroups = new Set();

  function loadData() {
    const savedTimers = localStorage.getItem('med_timers_v14');
    const savedLog = localStorage.getItem('med_log_v14');
    if (savedLog) dailyLog = JSON.parse(savedLog);
    if (savedTimers) {
      timers = JSON.parse(savedTimers);
      render();
    }
    updateTotalsUI();
  }

  function saveData() {
    localStorage.setItem('med_timers_v14', JSON.stringify(timers));
    localStorage.setItem('med_log_v14', JSON.stringify(dailyLog));
  }

  function toggleGroup(time) {
    if (collapsedGroups.has(time)) collapsedGroups.delete(time);
    else collapsedGroups.add(time);
    render();
  }

  function changeDoseNum(delta) {
    modalDoseNum = Math.max(1, modalDoseNum + delta);
    document.getElementById('stepperVal').textContent = modalDoseNum;
  }

  function checkOtherMedium(val) {
    const otherInput = document.getElementById('modalInputOtherMedium');
    otherInput.style.display = (val === 'Other') ? 'block' : 'none';
  }

  function checkOtherUnit(val) {
    const otherInput = document.getElementById('modalInputOtherUnit');
    otherInput.style.display = (val === 'Other') ? 'block' : 'none';
  }

  function openModal() { 
    modalDoseNum = 1;
    document.getElementById('stepperVal').textContent = '1';
    document.getElementById('modalSelectMedium').value = 'Tablet';
    document.getElementById('modalSelectUnit').value = 'mg';
    document.getElementById('modalSelectRelease').value = '';
    document.getElementById('modalInputTime').value = '08:00';
    checkOtherMedium('Tablet');
    checkOtherUnit('mg');
    document.getElementById('modalOverlay').classList.add('show'); 
  }
  
  function closeModal() { document.getElementById('modalOverlay').classList.remove('show'); }

  function saveNewTimer() {
    const name = document.getElementById('modalInput').value;
    const amount = parseFloat(document.getElementById('modalInputDosage').value || 0);
    const timeGroup = document.getElementById('modalInputTime').value;
    const roa = document.getElementById('modalSelectRoa').value;
    const release = document.getElementById('modalSelectRelease').value;
    
    let unit = document.getElementById('modalSelectUnit').value;
    if (unit === 'Other') unit = document.getElementById('modalInputOtherUnit').value || 'unit';
    let medium = document.getElementById('modalSelectMedium').value;
    if (medium === 'Other') medium = document.getElementById('modalInputOtherMedium').value || 'Other';

    if (!name || !timeGroup) return;
    if (!dailyLog[name]) dailyLog[name] = 0;
    dailyLog[name] += amount;

    timers.push({
      id: Date.now(),
      name,
      dosageAmount: amount,
      timeGroup,
      unit,
      roa,
      medium,
      release,
      doseNum: modalDoseNum,
      startedAt: null,
      elapsed: 0,
      running: false
    });

    saveData();
    render();
    updateTotalsUI();
    closeModal();
  }

  function startGroupTimers(time) {
    const now = Date.now();
    timers.forEach(t => {
      if (t.timeGroup === time && !t.running) {
        t.running = true;
        t.startedAt = now;
      }
    });
    saveData();
    render();
  }

  function startTimer(id) {
    const t = timers.find(t => t.id === id);
    t.running = true;
    t.startedAt = Date.now();
    saveData();
    render();
  }

  function stopTimer(id) {
    const t = timers.find(t => t.id === id);
    t.elapsed += (Date.now() - t.startedAt);
    t.running = false;
    t.startedAt = null;
    saveData();
    render();
  }

  function deleteTimer(id) {
    if(confirm("Remove this medication and clear its cumulative history?")) {
        const t = timers.find(item => item.id === id);
        if(t) {
            delete dailyLog[t.name]; // Automatically remove from cumulative tracking
        }
        timers = timers.filter(item => item.id !== id);
        saveData();
        render();
        updateTotalsUI();
    }
  }

  function confirmClearTotals() {
    if (confirm("Clear all cumulative dose totals?")) {
        dailyLog = {};
        saveData();
        updateTotalsUI();
    }
  }

  function formatTime(ms) {
    const s = Math.floor(ms / 1000);
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const sec = s % 60;
    const pad = n => String(n).padStart(2, '0');
    return h > 0 ? `${pad(h)}:${pad(m)}:${pad(sec)}` : `${pad(m)}:${pad(sec)}`;
  }

  function toggleDrawer() { document.getElementById('drawer').classList.toggle('open'); }

  function updateTotalsUI() {
    const list = document.getElementById('totalsList');
    list.innerHTML = '';
    const entries = Object.entries(dailyLog);
    if (entries.length === 0) {
        list.innerHTML = '<p style="color:#888; text-align: center; padding: 20px;">No doses recorded yet.</p>';
        return;
    }
    entries.forEach(([name, total]) => {
        const timer = timers.find(t => t.name === name);
        const unit = timer ? timer.unit : '';
        list.innerHTML += `<div class="total-row"><div><span style="display:block; font-weight:700;">${name}</span><span style="font-size:0.9rem;">${total} ${unit}</span></div></div>`;
    });
  }

  function render() {
    const root = document.getElementById('timersRoot');
    root.innerHTML = '';
    const groups = {};
    timers.forEach(t => {
      if (!groups[t.timeGroup]) groups[t.timeGroup] = [];
      groups[t.timeGroup].push(t);
    });
    const sortedTimes = Object.keys(groups).sort();

    const clockSvg = `<svg class="clock-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`;

    sortedTimes.forEach(time => {
      const groupDiv = document.createElement('div');
      groupDiv.className = 'timing-group';
      const isCollapsed = collapsedGroups.has(time);
      const groupTimers = groups[time];
      const hasStopped = groupTimers.some(t => !t.running);

      groupDiv.innerHTML = `
        <div class="group-header" onclick="toggleGroup('${time}')">
          <span style="display:flex; align-items:center;">${clockSvg} ${time} (${groupTimers.length})</span>
          <div style="display:flex; gap:10px; align-items:center;">
            ${hasStopped ? `<button class="btn btn-start" style="padding:4px 8px; font-size:0.55rem;" onclick="event.stopPropagation(); startGroupTimers('${time}')">Start All</button>` : ''}
            <span style="font-size:0.6rem;">${isCollapsed ? 'SHOW' : 'HIDE'}</span>
          </div>
        </div>
        <div class="group-content ${isCollapsed ? 'collapsed' : ''}">
          ${groupTimers.map(t => `
            <div class="timer-card ${t.running ? 'running' : ''}">
              <div class="name-row">
                <span class="med-title">${t.name}</span>
                <button style="border:none; background:none; color:#ddd; font-size: 1.2rem; margin-left: auto;" onclick="deleteTimer(${t.id})">✕</button>
              </div>
              <div class="name-row" style="margin-top: -5px; gap: 4px;">
                <span class="badge">${t.dosageAmount}${t.unit}</span>
                <span class="badge">${t.medium}</span>
                ${t.release ? `<span class="badge">${t.release}</span>` : ''}
              </div>
              <div class="name-row" style="margin-top: -8px; gap: 4px;">
                <span class="badge badge-yellow">${t.roa}</span>
                <span class="badge badge-red">Dose ${t.doseNum}</span>
              </div>
              <div class="time-display" id="time-${t.id}">${formatTime(t.running ? t.elapsed + (Date.now() - t.startedAt) : t.elapsed)}</div>
              <div class="controls">
                ${t.running ? 
                  `<button class="btn btn-stop" onclick="stopTimer(${t.id})">Stop</button>` : 
                  `<button class="btn btn-start" onclick="startTimer(${t.id})">Start</button>`}
              </div>
            </div>
          `).join('')}
        </div>
      `;
      root.appendChild(groupDiv);
    });
  }

  setInterval(() => {
    timers.forEach(t => {
      if (t.running) {
        const el = document.getElementById(`time-${t.id}`);
        if (el) el.textContent = formatTime(t.elapsed + (Date.now() - t.startedAt));
      }
    });
  }, 1000);

  loadData();
</script>
</body>
</html>
