<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>Med Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
  :root {
    --bg: #f8f9fa;
    --surface: #ffffff;
    --accent: #2dbb5d; 
    --text: #000000;
    --text-muted: #555555;
    --danger: #d93025;
    --border: #dee2e6;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Mono', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 20px 20px 120px;
  }

  .header { text-align: center; margin-bottom: 30px; }
  .header h1 { font-family: 'Playfair Display', serif; font-size: 2rem; }
  .header p { color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; }

  .container { max-width: 520px; margin: 0 auto; display: flex; flex-direction: column; gap: 16px; }

  .timer-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }
  .timer-card.running { border-color: var(--accent); border-width: 2px; }

  .name-row { display: flex; flex-wrap: wrap; align-items: center; gap: 6px; margin-bottom: 10px; }
  .med-title { font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: 700; flex: 1; min-width: 150px; }

  .time-display { 
    font-family: 'DM Mono', monospace; 
    font-size: 2.8rem; 
    text-align: center; 
    margin: 10px 0 20px; 
    color: var(--text);
  }
  .running .time-display { color: var(--accent); }

  .controls { display: flex; justify-content: center; gap: 10px; }
  .btn { 
    font-family: 'DM Mono', monospace; 
    font-size: 0.7rem; 
    text-transform: uppercase; 
    border: 1.5px solid; 
    border-radius: 8px; 
    padding: 8px 16px; 
    cursor: pointer; 
    background: white;
    color: var(--text);
  }
  .btn-start { border-color: var(--accent); color: var(--accent); }
  .btn-stop { border-color: var(--danger); color: var(--danger); }
  .btn-reset { border-color: #777; color: #777; }
  .btn-danger-fill { background: var(--danger); color: white; border: none; }

  .badge { font-size: 0.6rem; padding: 2px 6px; border-radius: 10px; background: #eee; font-weight: 600; color: #333; text-transform: uppercase; }
  .roa-badge { background: #e7f3ff; color: #007bff; }
  .dose-num-badge { background: #fff3cd; color: #856404; }

  /* Drawer Styles */
  .drawer {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: white;
    border-top: 1px solid var(--border);
    border-radius: 20px 20px 0 0;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1000;
    padding: 20px;
    max-height: 70vh;
    overflow-y: auto;
    box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
  }
  .drawer.open { transform: translateY(0); }
  .drawer-handle { width: 40px; height: 5px; background: #ddd; border-radius: 10px; margin: -10px auto 20px; }
  .total-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f0f0f0; color: black; }

  .summary-bar {
    position: fixed;
    bottom: 20px; left: 50%;
    transform: translateX(-50%);
    background: black;
    color: white;
    padding: 14px 28px;
    border-radius: 30px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    z-index: 999;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }

  /* Modal Layout */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 1100; justify-content: center; align-items: center; }
  .modal-overlay.show { display: flex; }
  .modal { background: white; border-radius: 20px; padding: 25px; width: 90%; max-width: 400px; color: black; }
  .modal-input, .modal-select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border); border-radius: 8px; font-family: 'DM Mono'; font-size: 0.9rem; }
  
  .stepper-row { display: flex; align-items: center; margin-bottom: 15px; }
  .stepper-btn { background: #eee; border: 1px solid var(--border); width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem; }
  .stepper-num { flex: 1; text-align: center; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); height: 40px; line-height: 40px; }
</style>
</head>
<body>

<div class="header">
  <h1>Medication Tracker</h1>
  <p>Follow & time your medications.</p>
</div>

<div class="container" id="container">
  <button class="btn btn-reset" style="width:100%; padding:15px; margin-bottom:10px; color:black; border-color: black;" onclick="openModal()">+ Add New Med</button>
</div>

<div class="summary-bar" onclick="toggleDrawer()">
  View Cumulative Totals ðŸ“Š
</div>

<div class="drawer" id="drawer">
  <div class="drawer-handle" onclick="toggleDrawer()"></div>
  <h2 style="font-family:'Playfair Display'; margin-bottom:5px; color: black;">Dose Tracking</h2>
  <div id="totalsList"></div>
  <div style="margin-top: 30px; display: flex; flex-direction: column; gap: 10px;">
    <button class="btn btn-danger-fill" style="width:100%; padding: 12px;" onclick="confirmClearTotals()">Reset All Totals</button>
    <button class="btn btn-reset" style="width:100%; padding: 12px; color: black;" onclick="toggleDrawer()">Close</button>
  </div>
</div>

<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <h2 style="font-family:'Playfair Display'; margin-bottom: 15px;">Add Medication</h2>
    <input class="modal-input" id="modalInput" type="text" placeholder="Name (e.g. Advil)">
    <input class="modal-input" id="modalInputDosage" type="number" placeholder="Dose amount (e.g. 200)">
    <input class="modal-input" id="modalInputUnit" type="text" placeholder="Unit (e.g. mg)">
    
    <label style="font-size: 0.7rem; text-transform: uppercase; color: #777;">Route</label>
    <select class="modal-select" id="modalSelectRoa">
        <option value="Oral">Oral</option>
        <option value="Sublingual">Sublingual</option>
        <option value="Topical">Topical</option>
        <option value="Inhalation">Inhalation</option>
        <option value="Nasal">Nasal</option>
        <option value="Injection">Injection</option>
    </select>

    <label style="font-size: 0.7rem; text-transform: uppercase; color: #777;">Initial Dose #</label>
    <div class="stepper-row">
      <button class="stepper-btn" style="border-radius: 8px 0 0 8px;" onclick="changeDoseNum(-1)">âˆ’</button>
      <div class="stepper-num" id="stepperVal">1</div>
      <button class="stepper-btn" style="border-radius: 0 8px 8px 0;" onclick="changeDoseNum(1)">+</button>
    </div>

    <div style="display:flex; gap:10px; margin-top:10px">
      <button class="btn btn-reset" style="flex:1; color: black;" onclick="closeModal()">Cancel</button>
      <button class="btn btn-start" style="flex:1" onclick="saveNewTimer()">Add</button>
    </div>
  </div>
</div>

<script>
  let timers = [];
  let dailyLog = {}; 
  let modalDoseNum = 1;

  function loadData() {
    const savedTimers = localStorage.getItem('med_timers_v5');
    const savedLog = localStorage.getItem('med_log_v5');
    if (savedLog) dailyLog = JSON.parse(savedLog);
    if (savedTimers) {
      timers = JSON.parse(savedTimers);
      render();
    }
    updateTotalsUI();
  }

  function saveData() {
    localStorage.setItem('med_timers_v5', JSON.stringify(timers));
    localStorage.setItem('med_log_v5', JSON.stringify(dailyLog));
  }

  function changeDoseNum(delta) {
    modalDoseNum = Math.max(1, modalDoseNum + delta);
    document.getElementById('stepperVal').textContent = modalDoseNum;
  }

  function openModal() { 
    modalDoseNum = 1;
    document.getElementById('stepperVal').textContent = '1';
    document.getElementById('modalOverlay').classList.add('show'); 
  }
  
  function closeModal() { document.getElementById('modalOverlay').classList.remove('show'); }

  function saveNewTimer() {
    const name = document.getElementById('modalInput').value;
    const amount = parseFloat(document.getElementById('modalInputDosage').value || 0);
    const unit = document.getElementById('modalInputUnit').value || 'units';
    const roa = document.getElementById('modalSelectRoa').value;

    if (!name) return;

    // ADDED LOGIC: Immediately track the dose when added
    if (!dailyLog[name]) dailyLog[name] = 0;
    dailyLog[name] += amount;

    timers.push({
      id: Date.now(),
      name,
      dosageAmount: amount,
      unit,
      roa,
      doseNum: modalDoseNum,
      startedAt: null,
      elapsed: 0,
      running: false
    });

    saveData();
    render();
    updateTotalsUI();
    closeModal();
    
    document.getElementById('modalInput').value = '';
    document.getElementById('modalInputDosage').value = '';
    document.getElementById('modalInputUnit').value = '';
  }

  function logDose(timer) {
    if (!dailyLog[timer.name]) dailyLog[timer.name] = 0;
    dailyLog[timer.name] += timer.dosageAmount;
    timer.doseNum++; 
    saveData();
    updateTotalsUI();
  }

  function startTimer(id) {
    const t = timers.find(t => t.id === id);
    t.running = true;
    t.startedAt = Date.now();
    saveData();
    render();
  }

  function stopTimer(id) {
    const t = timers.find(t => t.id === id);
    t.elapsed += (Date.now() - t.startedAt);
    t.running = false;
    t.startedAt = null;
    logDose(t);
    saveData();
    render();
  }

  function resetTimer(id) {
    const t = timers.find(t => t.id === id);
    if (t.running) stopTimer(id);
    else logDose(t); 
    t.elapsed = 0;
    t.running = false;
    t.startedAt = null;
    saveData();
    render();
  }

  function deleteTimer(id) {
    if(confirm("Remove this medication?")) {
        timers = timers.filter(t => t.id !== id);
        saveData();
        render();
    }
  }

  function confirmClearTotals() {
    if (confirm("Clear all cumulative dose totals?")) {
        dailyLog = {};
        saveData();
        updateTotalsUI();
    }
  }

  function formatTime(ms) {
    const s = Math.floor(ms / 1000);
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const sec = s % 60;
    const pad = n => String(n).padStart(2, '0');
    return h > 0 ? `${pad(h)}:${pad(m)}:${pad(sec)}` : `${pad(m)}:${pad(sec)}`;
  }

  function toggleDrawer() { document.getElementById('drawer').classList.toggle('open'); }

  function updateTotalsUI() {
    const list = document.getElementById('totalsList');
    list.innerHTML = '';
    const entries = Object.entries(dailyLog);
    if (entries.length === 0) {
        list.innerHTML = '<p style="color:#888; text-align: center; padding: 20px;">No doses logged yet.</p>';
        return;
    }
    entries.forEach(([name, total]) => {
        const timer = timers.find(t => t.name === name);
        const unit = timer ? timer.unit : '';
        list.innerHTML += `<div class="total-row"><span>${name}</span><strong>${total} ${unit}</strong></div>`;
    });
  }

  function render() {
    const container = document.getElementById('container');
    const addBtn = container.querySelector('.btn-reset[onclick="openModal()"]');
    container.querySelectorAll('.timer-card').forEach(el => el.remove());

    timers.forEach(t => {
      const card = document.createElement('div');
      card.className = `timer-card ${t.running ? 'running' : ''}`;
      card.innerHTML = `
        <div class="name-row">
          <span class="med-title">${t.name}</span>
          <span class="badge">${t.dosageAmount}${t.unit}</span>
          <span class="badge roa-badge">${t.roa}</span>
          <span class="badge dose-num-badge">Dose ${t.doseNum}</span>
          <button style="border:none; background:none; color:#ddd; font-size: 1.2rem;" onclick="deleteTimer(${t.id})">âœ•</button>
        </div>
        <div class="time-display" id="time-${t.id}">${formatTime(t.running ? t.elapsed + (Date.now() - t.startedAt) : t.elapsed)}</div>
        <div class="controls">
          ${t.running ? 
            `<button class="btn btn-stop" onclick="stopTimer(${t.id})">Stop & Log</button>` : 
            `<button class="btn btn-start" onclick="startTimer(${t.id})">Start Timer</button>`}
          <button class="btn btn-reset" onclick="resetTimer(${t.id})">Log & Reset</button>
        </div>
      `;
      container.insertBefore(card, addBtn);
    });
  }

  setInterval(() => {
    timers.forEach(t => {
      if (t.running) {
        const el = document.getElementById(`time-${t.id}`);
        if (el) el.textContent = formatTime(t.elapsed + (Date.now() - t.startedAt));
      }
    });
  }, 1000);

  loadData();
</script>
</body>
</html>
